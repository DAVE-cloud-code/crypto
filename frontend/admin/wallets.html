<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Wallet Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
    button {
      padding: 5px 10px;
      margin: 0 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .edit-btn {
      background-color: #28a745;
      color: white;
    }
    .delete-btn {
      background-color: #dc3545;
      color: white;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      width: 300px;
      text-align: center;
    }
    .modal-content input {
      width: 100%;
      padding: 8px;
      margin: 10px 0;
    }
    .modal-content button {
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <h1>Wallet Management</h1>

  <table id="walletTable">
    <thead>
      <tr>
        <th>Crypto Type</th>
        <th>Address</th>
        <th>Added At</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- wallets will be populated here -->
    </tbody>
  </table>

  <!-- Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Edit Wallet Address</h3>
      <input type="text" id="editAddress" placeholder="Enter new wallet address">
      <button id="saveBtn" class="edit-btn">Save</button>
      <button onclick="closeModal()" class="delete-btn">Cancel</button>
    </div>
  </div>

  <script>
   const API_URL = 'https://oreantrade.onrender.com/api/wallets';
const tbody = document.querySelector('#walletTable tbody');
const editModal = document.getElementById('editModal');
const editAddressInput = document.getElementById('editAddress');
const searchInput = document.getElementById('searchInput');
let currentEditingId = '';

// Get Token from localStorage
const token = localStorage.getItem('adminToken');

// Global fetch with Authorization
async function authorizedFetch(url, options = {}) {
  if (!token) {
    alert('No admin token found, please login again.');
    window.location.href = '/admin-login.html'; // redirect to your admin login page
    return;
  }
  
  options.headers = {
    ...(options.headers || {}),
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  };

  const res = await fetch(url, options);

  if (res.status === 401) { 
    // Unauthorized
    localStorage.removeItem('adminToken');
    alert('Session expired, please login again.');
    window.location.href = '/admin-login.html'; 
    return;
  }

  return res;
}

// Load wallets
async function loadWallets(filter = '') {
  try {
    const res = await authorizedFetch(`${API_URL}/get-wallets`);
    const wallets = await res.json();
    tbody.innerHTML = '';

    wallets
      .filter(wallet => wallet.cryptoType.toLowerCase().includes(filter.toLowerCase()))
      .forEach(wallet => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${wallet.cryptoType}</td>
          <td>${wallet.address}</td>
          <td>${new Date(wallet.addedAt).toLocaleString()}</td>
          <td>
            <button class="edit-btn" onclick="openEditModal('${wallet._id}', '${wallet.address}')">Edit</button>
            <button class="delete-btn" onclick="deleteWallet('${wallet._id}')">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

  } catch (error) {
    console.error('Failed to load wallets', error);
  }
}

// Open Modal
function openEditModal(id, address) {
  currentEditingId = id;
  editAddressInput.value = address;
  editModal.style.display = 'flex';
}

// Close Modal
function closeModal() {
  editModal.style.display = 'none';
}

// Save Updated Address
document.getElementById('saveBtn').addEventListener('click', async () => {
  const newAddress = editAddressInput.value.trim();

  if (newAddress.length > 42) {
    showToast('Wallet address is too long!', 'error');
    return;
  }

  try {
    const res = await authorizedFetch(`${API_URL}/update-wallet/${currentEditingId}`, {
      method: 'PUT',
      body: JSON.stringify({ address: newAddress })
    });

    if (!res.ok) throw new Error('Update failed');

    showToast('Wallet updated successfully!', 'success');
    closeModal();
    loadWallets();
  } catch (error) {
    console.error(error);
    showToast('Error updating wallet', 'error');
  }
});

// Delete Wallet
async function deleteWallet(id) {
  if (confirm('Are you sure you want to delete this wallet?')) {
    try {
      const res = await authorizedFetch(`${API_URL}/delete-wallet/${id}`, {
        method: 'DELETE'
      });

      if (!res.ok) throw new Error('Delete failed');

      showToast('Wallet deleted successfully!', 'success');
      loadWallets();
    } catch (error) {
      console.error(error);
      showToast('Error deleting wallet', 'error');
    }
  }
}

// Search functionality
searchInput.addEventListener('input', () => {
  const filter = searchInput.value.trim();
  loadWallets(filter);
});

// Toast function
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerText = message;
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// On load
loadWallets();

  </script>

</body>
</html>
